"use strict";var e,t=(e=require("aws-sdk"))&&"object"==typeof e&&"default"in e?e.default:e;function r(){return(r=Object.assign||function(e){for(var t=1;t<arguments.length;t++){var r=arguments[t];for(var n in r)Object.prototype.hasOwnProperty.call(r,n)&&(e[n]=r[n])}return e}).apply(this,arguments)}var n=new t.DynamoDB.DocumentClient;function o(){return n}function i(e){return"lsi"+e}function a(e){return"lsi"+e}function s(e,t){return"gsi"+t+e}var u="SingleTable";function c(){return u}function y(e){if("globalSecondaryIndex"===e.type)return{IndexName:e.indexName,KeySchema:[{AttributeName:e.hashKeyAttribute,KeyType:"HASH"},{AttributeName:e.sortKeyAttribute,KeyType:"RANGE"}],Projection:{ProjectionType:"INCLUDE",NonKeyAttributes:["data","objectType"]}};throw{message:"given index of type "+e.type+", expecting globalSecondaryIndex"}}function l(e,t){return void 0===t&&(t=""),{hashKeyFields:e.hashKeyFields,hashKeyDescriptor:e.objectName,hashKeyAttribute:"hashKey",sortKeyFields:e.sortKeyFields||[],sortKeyDescriptor:e.objectName,sortKeyAttribute:"sortKey",type:"primaryIndex",tag:t}}function h(e,t,r,n){return[r].concat(t.map((function(t){return f(t,e[t])}))).join(n)}function f(e,t){return e+"-"+t}function d(e,t){if(e.index){if(t.indexesByTag[e.index])return t.indexesByTag[e.index];throw{message:'The index "'+e.index+'" does not exist, the following are valid indexes: '+Object.keys(t.indexesByTag).join(",")}}for(var r=t.indexes,n=function(t){var n=r[t],o=new Set(Object.keys(e.args));if(n.hashKeyFields.every((function(e){return o.has(e)}))){n.hashKeyFields.forEach((function(e){return o.delete(e)}));var i=o.size;if(n.sortKeyFields.slice(0,o.size).forEach((function(e){return o.delete(e)})),0===o.size){if(!e.sortBy)return{v:n};if(n.sortKeyFields.indexOf(e.sortBy)===i)return{v:n}}}},o=0;o<r.length;o++){var i=n(o);if("object"==typeof i)return i.v}return null}function m(e,t,r){var n;return(n={})[t.hashKeyAttribute]=h(e,t.hashKeyFields,t.hashKeyDescriptor,r),n[t.sortKeyAttribute]=h(e,t.sortKeyFields,t.sortKeyDescriptor,r),n}const b=function(){function e(){}return e.prototype.then=function(t,r){const n=new e,o=this.s;if(o){const e=1&o?t:r;if(e){try{p(n,1,e(this.v))}catch(e){p(n,2,e)}return n}return this}return this.o=function(e){try{const o=e.v;1&e.s?p(n,1,t?t(o):o):r?p(n,1,r(o)):p(n,2,o)}catch(e){p(n,2,e)}},n},e}();function p(e,t,r){if(!e.s){if(r instanceof b){if(!r.s)return void(r.o=p.bind(null,e,t));1&t&&(t=r.s),r=r.v}if(r&&r.then)return void r.then(p.bind(null,e,t),p.bind(null,e,2));e.s=t,e.v=r;const n=e.o;n&&n(e)}}"undefined"!=typeof Symbol&&(Symbol.iterator||(Symbol.iterator=Symbol("Symbol.iterator"))),"undefined"!=typeof Symbol&&(Symbol.asyncIterator||(Symbol.asyncIterator=Symbol("Symbol.asyncIterator"))),exports.AWS=t,exports.WORKAROUND_updateAWSConfig=function(e){t.config.update(e),n=new t.DynamoDB.DocumentClient(e)},exports.ensureTableAndIndexesExist=function(e){try{console.log(t.config.region);var n={};e.map((function(e){return e.config})).forEach((function(e){n[e.tableName]||(n[e.tableName]={}),e.indexes.forEach((function(t){"globalSecondaryIndex"===t.type&&(n[e.tableName][t.indexName]=t)}))}));var o=Object.keys(n),s=function(e,t,r){var n,o,i=-1;return function r(a){try{for(;++i<e.length;)if((a=t(i))&&a.then){if(!((s=a)instanceof b&&1&s.s))return void a.then(r,o||(o=p.bind(null,n=new b,2)));a=a.v}n?p(n,1,a):n=a}catch(e){p(n||(n=new b),2,e)}var s}(),n}(o,(function(e){return Promise.resolve(function(e,n){try{var o=new t.DynamoDB;return console.log('checking if the table "'+e+'" has already been created'),Promise.resolve(function(e,t){try{var r=function(e){return n?e:(console.log("returning nullll"),null)},n=!1,o=function(r,o){try{var i=Promise.resolve(e.describeTable({TableName:t}).promise()).then((function(e){if(e.Table)return console.log("returning table description!!!!"),n=!0,e.Table}))}catch(e){return o(e)}return i&&i.then?i.then(void 0,o):i}(0,(function(e){console.log(e)}));return Promise.resolve(o&&o.then?o.then(r):r(o))}catch(e){return Promise.reject(e)}}(o,e)).then((function(s){var u=!1;function l(t){if(u)return t;console.log('table "'+e+'" already exists, checking the indexes'),s&&(s.GlobalSecondaryIndexes||[]).forEach((function(e){delete h[e.IndexName||""]}));var r=Object.values(h),n=function(){if(r.length>0)return console.log("creating the following indexes "+Object.keys(h).join(",")+" to table "+e),Promise.resolve(o.updateTable({TableName:e,GlobalSecondaryIndexUpdates:r.map((function(e){return{Create:y(e)}}))}).promise()).then((function(){}));console.log("the table "+e+" has all the necessary indexes")}();return n&&n.then?n.then((function(){})):void 0}var h=r({},n),f=function(){if(!s){var r=Object.values(h);return console.log('table "'+e+'" does not exist, creating it now'),Promise.resolve(function(e){var r=new t.DynamoDB,n=function(e,t){for(var r=[],n=0;n<=4;n++)r.push(n);return r}().map((function(e){return{indexName:i(e),sortKeyAttributeName:a(e)}})),o=(e.indexes||[]).map((function(e){return y(e)})),s={TableName:e.tableName||c(),KeySchema:[{AttributeName:"hashKey",KeyType:"HASH"},{AttributeName:"sortKey",KeyType:"RANGE"}],AttributeDefinitions:[{AttributeName:"hashKey",AttributeType:"S"},{AttributeName:"sortKey",AttributeType:"S"}].concat(n.map((function(e){return{AttributeName:e.sortKeyAttributeName,AttributeType:"S"}})),e.indexes.map((function(e){return{AttributeName:e.sortKeyAttribute,AttributeType:"S"}})),e.indexes.map((function(e){return{AttributeName:e.hashKeyAttribute,AttributeType:"S"}}))),LocalSecondaryIndexes:[].concat(n.map((function(e){return{IndexName:e.indexName,KeySchema:[{AttributeName:"hashKey",KeyType:"HASH"},{AttributeName:e.sortKeyAttributeName,KeyType:"RANGE"}],Projection:{ProjectionType:"INCLUDE",NonKeyAttributes:["data","objectType"]}}}))),GlobalSecondaryIndexes:o,BillingMode:"PAY_PER_REQUEST"};return r.createTable(s).promise()}({tableName:e,indexes:r})).then((function(){console.log('table "'+e+'" created with the following indexes '+Object.keys(h).join(",")),u=!0}))}}();return f&&f.then?f.then(l):l(f)}))}catch(e){return Promise.reject(e)}}(o[e],n[o[e]])).then((function(){}))}));return Promise.resolve(s&&s.then?s.then((function(){})):void 0)}catch(e){return Promise.reject(e)}},exports.getRepository=function(e){var t=function(e){var t=Object.assign({queries:{}},e),n=[l(t)].concat(t.queries?Object.keys(t.queries).map((function(e){return function(e,t){var r,n=(t.queries||{})[e];if((r=n)&&r.isPrimary)return l(t,e);if(function(e){return e&&e.sortKeyFields&&!e.hashKeyFields}(n))return function(e,t,r){return{hashKeyFields:r.hashKeyFields,hashKeyDescriptor:r.objectName,hashKeyAttribute:"hashKey",sortKeyFields:t.sortKeyFields,sortKeyDescriptor:e,sortKeyAttribute:a(t.which),indexName:i(t.which),type:"localSecondaryIndex",tag:e}}(e,n,t);if(function(e){return e&&e.sortKeyFields&&e.hashKeyFields}(n))return function(e,t,r){return{hashKeyFields:t.hashKeyFields,hashKeyDescriptor:r.objectName+"-"+e,hashKeyAttribute:s(t.which,"Hash"),sortKeyFields:t.sortKeyFields,sortKeyDescriptor:e,sortKeyAttribute:s(t.which,"Sort"),indexName:(n=t.which,"gsi"+n),type:"globalSecondaryIndex",tag:e};var n}(e,n,t);throw{message:e+" is not valid"}}(e,t)})):[]),o=n.reduce((function(e,t){var n;return r({},e,((n={})[t.tag]=t,n))}),{});return Object.assign({tableName:t.tableName||c(),compositeKeySeparator:t.compositeKeySeparator||"#"},{objectName:t.objectName,primaryIndex:n[0],indexes:n,indexesByTag:o})}(e),n={get config(){return t},getKey:function(e){return m(e,t.primaryIndex,t.compositeKeySeparator)},get:function(e){try{return Promise.resolve(o().get({TableName:t.tableName,Key:n.getKey(e)}).promise()).then((function(e){return e.Item?e.Item.data:null}))}catch(e){return Promise.reject(e)}},update:function(e,t){try{return Promise.resolve(n.get(e)).then((function(e){var o=r({},e,{},t);return n.overwrite(o)}))}catch(e){return Promise.reject(e)}},put:function(e){return n.overwrite(e)},overwrite:function(e){try{return Promise.resolve(o().put({TableName:t.tableName,Item:n.formatForDDB(e)}).promise()).then((function(){return e}))}catch(e){return Promise.reject(e)}},delete:function(e){try{return Promise.resolve(o().delete({TableName:t.tableName,Key:n.getKey(e)}).promise()).then((function(){return!0}))}catch(e){return Promise.reject(e)}},executeQuery:function(e,n){try{var i=h(e.args,n.hashKeyFields,n.hashKeyDescriptor,t.compositeKeySeparator),a=n.sortKeyFields&&function(e,t,r,n){for(var o=[r],i=0;i<t.length;i++){var a=t[i];if(!(a in e))break;o.push(f(a,String(e[a])))}return o.join(n)}(e.args,n.sortKeyFields,n.sortKeyDescriptor,t.compositeKeySeparator);return Promise.resolve(o().query(r({TableName:t.tableName},n.indexName&&{IndexName:n.indexName},{Limit:e.limit||5,ScanIndexForward:"asc"===e.sort,KeyConditionExpression:n.hashKeyAttribute+" = :hKey and begins_with("+n.sortKeyAttribute+", :sKey) ",ExpressionAttributeValues:{":hKey":i,":sKey":a}},e.cursor&&{ExclusiveStartKey:e.cursor})).promise()).then((function(t){var n=t&&t.LastEvaluatedKey&&r({},e,{cursor:t.LastEvaluatedKey});return{results:t.Items.map((function(e){return e.data})),nextPageArgs:n}}))}catch(e){return Promise.reject(e)}},query:function(e){try{var r=d(e,t);if(!r)throw{message:"there isnt an index configured for this query"};return Promise.resolve(n.executeQuery(e,r))}catch(e){return Promise.reject(e)}},queryOne:function(e){try{var t=r({},e,{limit:1});return Promise.resolve(n.query(t)).then((function(e){return e.results.length>0?e.results[0]:null}))}catch(e){return Promise.reject(e)}},formatForDDB:function(e){var n={data:e,objectType:t.objectName};return t.indexes.forEach((function(o){n=r({},n,{},m(e,o,t.compositeKeySeparator))})),n},findIndexForQuery:function(e){return d(e,t)},queries:Object.keys(t.indexesByTag).reduce((function(e,r){return e[r]=function(e){return n.executeQuery(e,t.indexesByTag[r])},e}),{})};return n},exports.setDefaultTableName=function(e){u=e};
//# sourceMappingURL=single-table-dynamo.cjs.production.min.js.map
