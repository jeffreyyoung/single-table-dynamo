"use strict";var e,t=(e=require("aws-sdk"))&&"object"==typeof e&&"default"in e?e.default:e;function r(){return(r=Object.assign||function(e){for(var t=1;t<arguments.length;t++){var r=arguments[t];for(var n in r)Object.prototype.hasOwnProperty.call(r,n)&&(e[n]=r[n])}return e}).apply(this,arguments)}var n=new t.DynamoDB.DocumentClient;function o(){return n}function i(e){if(!e)return null;var t={};return Object.keys(e).forEach((function(r){r.startsWith("__")||(t[r]=e[r])})),t}function s(e){return"__lsi"+e}function a(e){return"__lsi"+e}function u(e,t){return"__gsi"+t+e}var c="SingleTable";function y(){return c}function l(e){if("globalSecondaryIndex"===e.type)return{IndexName:e.indexName,KeySchema:[{AttributeName:e.hashKeyAttribute,KeyType:"HASH"},{AttributeName:e.sortKeyAttribute,KeyType:"RANGE"}],Projection:{ProjectionType:"ALL"}};throw{message:"given index of type "+e.type+", expecting globalSecondaryIndex"}}function h(e,t){return void 0===t&&(t=""),{isCustomIndex:!1,hashKeyFields:e.hashKeyFields,hashKeyDescriptor:e.objectName,hashKeyAttribute:"__hashKey",sortKeyFields:e.sortKeyFields||[],sortKeyDescriptor:e.objectName,sortKeyAttribute:"__sortKey",type:"primaryIndex",tag:t}}function d(e,t,r,n,o){return[r].concat(t.map((function(t){return f(t,e[t],o)}))).join(n)}function f(e,t,r){var n=String(t);return"number"==typeof t&&t>=0&&r&&(n=function(e){var t=String(e).split("."),r=t[1];return[(t[0]||"").padStart(18,"0"),(r||"").padEnd(2,"0")].join(".")}(t)),e+"-"+n}function m(e,t){if(e.index){if(t.indexesByTag[e.index])return t.indexesByTag[e.index];throw{message:'The index "'+e.index+'" does not exist, the following are valid indexes: '+Object.keys(t.indexesByTag).join(",")}}for(var r=t.indexes,n=function(t){var n=r[t],o=new Set(Object.keys(e.args));if(n.hashKeyFields.every((function(e){return o.has(e)}))){n.hashKeyFields.forEach((function(e){return o.delete(e)}));var i=o.size;if(n.sortKeyFields.slice(0,o.size).forEach((function(e){return o.delete(e)})),0===o.size){if(!e.sortBy)return{v:n};if(n.sortKeyFields.indexOf(e.sortBy)===i)return{v:n}}}},o=0;o<r.length;o++){var i=n(o);if("object"==typeof i)return i.v}return null}function b(e,t,r,n){var o;return(o={})[t.hashKeyAttribute]=d(e,t.hashKeyFields,t.hashKeyDescriptor,r,n),o[t.sortKeyAttribute]=d(e,t.sortKeyFields,t.sortKeyDescriptor,r,n),o}const K=function(){function e(){}return e.prototype.then=function(t,r){const n=new e,o=this.s;if(o){const e=1&o?t:r;if(e){try{p(n,1,e(this.v))}catch(e){p(n,2,e)}return n}return this}return this.o=function(e){try{const o=e.v;1&e.s?p(n,1,t?t(o):o):r?p(n,1,r(o)):p(n,2,o)}catch(e){p(n,2,e)}},n},e}();function p(e,t,r){if(!e.s){if(r instanceof K){if(!r.s)return void(r.o=p.bind(null,e,t));1&t&&(t=r.s),r=r.v}if(r&&r.then)return void r.then(p.bind(null,e,t),p.bind(null,e,2));e.s=t,e.v=r;const n=e.o;n&&n(e)}}"undefined"!=typeof Symbol&&(Symbol.iterator||(Symbol.iterator=Symbol("Symbol.iterator"))),"undefined"!=typeof Symbol&&(Symbol.asyncIterator||(Symbol.asyncIterator=Symbol("Symbol.asyncIterator"))),exports.AWS=t,exports.WORKAROUND_updateAWSConfig=function(e){t.config.update(e),n=new t.DynamoDB.DocumentClient(e)},exports.ensureTableAndIndexesExist=function(e){try{console.log(t.config.region);var n={};e.map((function(e){return e.config})).forEach((function(e){n[e.tableName]||(n[e.tableName]={}),e.indexes.forEach((function(t){"globalSecondaryIndex"===t.type&&(n[e.tableName][t.indexName]=t)}))}));var o=Object.keys(n),i=function(e,t,r){var n,o,i=-1;return function r(s){try{for(;++i<e.length;)if((s=t(i))&&s.then){if(!((a=s)instanceof K&&1&a.s))return void s.then(r,o||(o=p.bind(null,n=new K,2)));s=s.v}n?p(n,1,s):n=s}catch(e){p(n||(n=new K),2,e)}var a}(),n}(o,(function(e){return Promise.resolve(function(e,n){try{var o=new t.DynamoDB;return console.log('checking if the table "'+e+'" has already been created'),Promise.resolve(function(e,t){try{var r=function(e){return n?e:(console.log("returning nullll"),null)},n=!1,o=function(r,o){try{var i=(console.log("calling for describeTable"),Promise.resolve(e.describeTable({TableName:t}).promise()).then((function(e){if(e.Table)return console.log("returning table description"),n=!0,e.Table})))}catch(e){return o(e)}return i&&i.then?i.then(void 0,o):i}(0,(function(e){console.log(e)}));return Promise.resolve(o&&o.then?o.then(r):r(o))}catch(e){return Promise.reject(e)}}(o,e)).then((function(i){var u=!1;function c(t){if(u)return t;console.log('table "'+e+'" already exists, checking the indexes'),i&&(i.GlobalSecondaryIndexes||[]).forEach((function(e){delete h[e.IndexName||""]}));var r=Object.values(h),n=function(){if(r.length>0)return console.log("creating the following indexes "+Object.keys(h).join(",")+" to table "+e),Promise.resolve(o.updateTable({TableName:e,AttributeDefinitions:r.reduce((function(e,t){return e.concat([{AttributeName:t.sortKeyAttribute,AttributeType:"S"},{AttributeName:t.hashKeyAttribute,AttributeType:"S"}])}),[]),GlobalSecondaryIndexUpdates:r.map((function(e){return{Create:l(e)}}))}).promise()).then((function(){return Promise.resolve(o.waitFor("tableExists",{TableName:e})).then((function(){}))}));console.log("the table "+e+" has all the necessary indexes")}();return n&&n.then?n.then((function(){})):void 0}console.log("got the description",i);var h=r({},n),d=function(){if(!i){var r=Object.values(h);return console.log('table "'+e+'" does not exist, creating it now'),Promise.resolve(function(e){var r=new t.DynamoDB,n=function(e,t){for(var r=[],n=0;n<=4;n++)r.push(n);return r}().map((function(e){return{indexName:s(e),sortKeyAttributeName:a(e)}})),o=(e.indexes||[]).map((function(e){return l(e)})),i={TableName:e.tableName||y(),KeySchema:[{AttributeName:"__hashKey",KeyType:"HASH"},{AttributeName:"__sortKey",KeyType:"RANGE"}],AttributeDefinitions:[{AttributeName:"__hashKey",AttributeType:"S"},{AttributeName:"__sortKey",AttributeType:"S"}].concat(n.map((function(e){return{AttributeName:e.sortKeyAttributeName,AttributeType:"S"}})),e.indexes.map((function(e){return{AttributeName:e.sortKeyAttribute,AttributeType:"S"}})),e.indexes.map((function(e){return{AttributeName:e.hashKeyAttribute,AttributeType:"S"}}))),LocalSecondaryIndexes:[].concat(n.map((function(e){return{IndexName:e.indexName,KeySchema:[{AttributeName:"__hashKey",KeyType:"HASH"},{AttributeName:e.sortKeyAttributeName,KeyType:"RANGE"}],Projection:{ProjectionType:"ALL"}}}))),GlobalSecondaryIndexes:o,BillingMode:"PAY_PER_REQUEST"};return r.createTable(i).promise().then((function(){return r.waitFor("tableExists",{TableName:i.TableName})})).then((function(){return console.log(i.TableName+" has been created")}))}({tableName:e,indexes:r})).then((function(){console.log('table "'+e+'" created with the following indexes '+Object.keys(h).join(",")),u=!0}))}}();return d&&d.then?d.then(c):c(d)}))}catch(e){return Promise.reject(e)}}(o[e],n[o[e]])).then((function(){}))}));return Promise.resolve(i&&i.then?i.then((function(){})):void 0)}catch(e){return Promise.reject(e)}},exports.getRepository=function(e){var t=function(e){var t=Object.assign({shouldPadNumbersInIndexes:!0,paddedNumberLength:20,queries:{}},e),n=[h(t)].concat(t.queries?Object.keys(t.queries).map((function(e){return function(e,t){var r,n=(t.queries||{})[e];if((r=n)&&r.isPrimary)return h(t,e);if(function(e){return e&&e.sortKeyFields&&!e.hashKeyFields}(n))return function(e,t,r){return{isCustomIndex:!1,hashKeyFields:r.hashKeyFields,hashKeyDescriptor:r.objectName,hashKeyAttribute:"__hashKey",sortKeyFields:t.sortKeyFields,sortKeyDescriptor:e,sortKeyAttribute:a(t.which),indexName:s(t.which),type:"localSecondaryIndex",tag:e}}(e,n,t);if(function(e){return e&&e.sortKeyFields&&e.hashKeyFields}(n))return function(e,t,r){return{isCustomIndex:!1,hashKeyFields:t.hashKeyFields,hashKeyDescriptor:r.objectName+"-"+e,hashKeyAttribute:u(t.which,"Hash"),sortKeyFields:t.sortKeyFields,sortKeyDescriptor:e,sortKeyAttribute:u(t.which,"Sort"),indexName:(n=t.which,"__gsi"+n),type:"globalSecondaryIndex",tag:e};var n}(e,n,t);if(function(e){return e&&e.hashKeyAttributeName&&e.sortKeyAttributeName}(n))return function(e,t,r){return{isCustomIndex:!0,hashKeyFields:[],hashKeyDescriptor:r.objectName+"-"+e,hashKeyAttribute:t.hashKeyAttributeName,sortKeyFields:[],sortKeyDescriptor:e,sortKeyAttribute:t.sortKeyAttributeName,indexName:t.indexName||e,type:"globalSecondaryIndex",tag:e}}(e,n,t);throw{message:e+" is not valid"}}(e,t)})):[]),o=n.reduce((function(e,t){var n;return r({},e,((n={})[t.tag]=t,n))}),{});return Object.assign({tableName:t.tableName||y(),compositeKeySeparator:t.compositeKeySeparator||"#",shouldPadNumbersInIndexes:t.shouldPadNumbersInIndexes,paddedNumberLength:t.paddedNumberLength||20},{objectName:t.objectName,primaryIndex:n[0],indexes:n,indexesByTag:o})}(e),n={getDocClient:o,get config(){return t},getKey:function(e){return b(e,t.primaryIndex,t.compositeKeySeparator,t.shouldPadNumbersInIndexes)},get:function(e){try{var r={TableName:t.tableName,Key:n.getKey(e)};return Promise.resolve(o().get(r).promise()).then((function(e){return e.Item?i(e.Item):null}))}catch(e){return Promise.reject(e)}},update:function(e,t){try{return Promise.resolve(n.get(e)).then((function(e){var o=r({},e,{},t);return n.overwrite(o)}))}catch(e){return Promise.reject(e)}},put:function(e){return n.overwrite(e)},overwrite:function(e){try{return Promise.resolve(o().put({TableName:t.tableName,Item:n.formatForDDB(e)}).promise()).then((function(){return e}))}catch(e){return Promise.reject(e)}},delete:function(e){try{return Promise.resolve(o().delete({TableName:t.tableName,Key:n.getKey(e)}).promise()).then((function(){return!0}))}catch(e){return Promise.reject(e)}},getSortKeyAndHashKeyForQuery:function(e,r){if(r.isCustomIndex)return{hashKey:e.args[r.hashKeyAttribute],sortKey:e.args[r.sortKeyAttribute]};var n=d(e.args,r.hashKeyFields,r.hashKeyDescriptor,t.compositeKeySeparator,t.shouldPadNumbersInIndexes);return{sortKey:r.sortKeyFields&&function(e,t,r,n,o){for(var i=[r],s=0;s<t.length;s++){var a=t[s];if(!(a in e))break;i.push(f(a,String(e[a]),o))}return i.join(n)}(e.args,r.sortKeyFields,r.sortKeyDescriptor,t.compositeKeySeparator,t.shouldPadNumbersInIndexes),hashKey:n}},getQueryArgs:function(e,n){var o=this.getSortKeyAndHashKeyForQuery(e,n),i=o.sortKey,s=o.hashKey;return r({TableName:t.tableName},n.indexName&&{IndexName:n.indexName},{Limit:e.limit||5,ScanIndexForward:"asc"===e.sort,KeyConditionExpression:"#hKeyAttribute = :hKey "+(i?"and begins_with(#sKeyAttribute, :sKey)":""),ExpressionAttributeNames:r({"#hKeyAttribute":n.hashKeyAttribute},i&&{"#sKeyAttribute":n.sortKeyAttribute}),ExpressionAttributeValues:r({":hKey":s},i&&{":sKey":i})},e.cursor&&{ExclusiveStartKey:e.cursor})},executeQuery:function(e,t){try{return Promise.resolve(o().query(n.getQueryArgs(e,t)).promise()).then((function(t){var n=t&&t.LastEvaluatedKey&&r({},e,{cursor:t.LastEvaluatedKey});return{results:t.Items.map((function(e){return i(e)})),nextPageArgs:n}}))}catch(e){return Promise.reject(e)}},query:function(e){try{var r=m(e,t);if(!r)throw{message:"there isnt an index configured for this query"};return Promise.resolve(n.executeQuery(e,r))}catch(e){return Promise.reject(e)}},queryOne:function(e){try{var t=r({},e,{limit:1});return Promise.resolve(n.query(t)).then((function(e){return e.results.length>0?e.results[0]:null}))}catch(e){return Promise.reject(e)}},formatForDDB:function(e){var n=r({},e,{__objectType:t.objectName});return t.indexes.filter((function(e){return!e.isCustomIndex})).forEach((function(o){n=r({},n,{},b(e,o,t.compositeKeySeparator,t.shouldPadNumbersInIndexes))})),n},findIndexForQuery:function(e){return m(e,t)},queries:Object.keys(t.indexesByTag).reduce((function(e,r){return e[r]=function(e){return n.executeQuery(e,t.indexesByTag[r])},e}),{})};return n},exports.setDefaultTableName=function(e){c=e};
//# sourceMappingURL=single-table-dynamo.cjs.production.min.js.map
