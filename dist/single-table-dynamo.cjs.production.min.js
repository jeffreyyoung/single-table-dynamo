"use strict";var e,t=(e=require("aws-sdk"))&&"object"==typeof e&&"default"in e?e.default:e;function r(){return(r=Object.assign||function(e){for(var t=1;t<arguments.length;t++){var r=arguments[t];for(var n in r)Object.prototype.hasOwnProperty.call(r,n)&&(e[n]=r[n])}return e}).apply(this,arguments)}const n=function(){function e(){}return e.prototype.then=function(t,r){const n=new e,o=this.s;if(o){const e=1&o?t:r;if(e){try{i(n,1,e(this.v))}catch(e){i(n,2,e)}return n}return this}return this.o=function(e){try{const o=e.v;1&e.s?i(n,1,t?t(o):o):r?i(n,1,r(o)):i(n,2,o)}catch(e){i(n,2,e)}},n},e}();function i(e,t,r){if(!e.s){if(r instanceof n){if(!r.s)return void(r.o=i.bind(null,e,t));1&t&&(t=r.s),r=r.v}if(r&&r.then)return void r.then(i.bind(null,e,t),i.bind(null,e,2));e.s=t,e.v=r;const o=e.o;o&&o(e)}}function o(e){return e instanceof n&&1&e.s}function s(e,t,r){for(var s;;){var u=e();if(o(u)&&(u=u.v),!u)return a;if(u.then){s=0;break}var a=r();if(a&&a.then){if(!o(a)){s=1;break}a=a.s}if(t){var c=t();if(c&&c.then&&!o(c)){s=2;break}}}var h=new n,l=i.bind(null,h,2);return(0===s?u.then(f):1===s?a.then(y):c.then(d)).then(void 0,l),h;function y(n){a=n;do{if(t&&(c=t())&&c.then&&!o(c))return void c.then(d).then(void 0,l);if(!(u=e())||o(u)&&!u.v)return void i(h,1,a);if(u.then)return void u.then(f).then(void 0,l);o(a=r())&&(a=a.v)}while(!a||!a.then);a.then(y).then(void 0,l)}function f(e){e?(a=r())&&a.then?a.then(y).then(void 0,l):y(a):i(h,1,a)}function d(){(u=e())?u.then?u.then(f).then(void 0,l):f(u):i(h,1,a)}}"undefined"!=typeof Symbol&&(Symbol.iterator||(Symbol.iterator=Symbol("Symbol.iterator"))),"undefined"!=typeof Symbol&&(Symbol.asyncIterator||(Symbol.asyncIterator=Symbol("Symbol.asyncIterator")));var u=new t.DynamoDB.DocumentClient;function a(){return u}function c(e){if(!e)return null;var t={};return Object.keys(e).forEach((function(r){r.startsWith("__")||(t[r]=e[r])})),t}function h(e){return"__lsi"+e}function l(e){return"__lsi"+e}function y(e,t){return"__gsi"+t+e}var f="SingleTable";function d(){return f}function m(e){if("globalSecondaryIndex"===e.type)return{IndexName:e.indexName,KeySchema:[{AttributeName:e.hashKeyAttribute,KeyType:"HASH"},{AttributeName:e.sortKeyAttribute,KeyType:"RANGE"}],Projection:{ProjectionType:"ALL"}};throw{message:"given index of type "+e.type+", expecting globalSecondaryIndex"}}function b(e,t){return void 0===t&&(t=""),{isCustomIndex:!1,hashKeyFields:e.hashKeyFields,hashKeyDescriptor:e.objectName,hashKeyAttribute:"__hashKey",sortKeyFields:e.sortKeyFields||[],sortKeyDescriptor:e.objectName,sortKeyAttribute:"__sortKey",type:"primaryIndex",tag:t}}var p=function(){function e(e){this.clause={args:{}},this.repo=e}var t=e.prototype;return t.where=function(e){return this.clause.args=e,this},t.sortBy=function(e){return this.clause.sortBy=e,this},t.sortDirection=function(e){return this.clause.sort=e,this},t.index=function(e){return this.clause.index=e,this},t.cursor=function(e){return this.clause.cursor=e,this},t.limit=function(e){return this.clause.limit=e,this},t.setClause=function(e){return this.clause=e,this},t.get=function(){var e=this.repo.findIndexForQuery(this.clause);if(!e)throw{message:"there isnt an index configured for this query"};return this.repo.executeQuery(this.clause,e)},t.getOne=function(){try{return Promise.resolve(this.limit(1).get()).then((function(e){return e.results.length>0?e.results[0]:null}))}catch(e){return Promise.reject(e)}},t.getAll=function(){try{var e=this;return Promise.resolve(e.get()).then((function(t){var r=s((function(){return!!t.nextPageArgs}),void 0,(function(){return Promise.resolve(e.setClause(t.nextPageArgs).get()).then((function(e){t={results:t.results.concat(e.results),nextPageArgs:e.nextPageArgs}}))}));return r&&r.then?r.then((function(){return t})):t}))}catch(e){return Promise.reject(e)}},t.deleteAll=function(){try{var e=this,t=!0;return Promise.resolve(e.limit(25).get()).then((function(r){var n=s((function(){return!!t}),void 0,(function(){return Promise.resolve(e.repo.batchDelete(r.results)).then((function(){var n=function(){if(r.nextPageArgs)return Promise.resolve(e.setClause(r.nextPageArgs).get()).then((function(e){r=e}));t=!1}();if(n&&n.then)return n.then((function(){}))}))}));return!n||!n.then||n.then((function(){return!0}))}))}catch(e){return Promise.reject(e)}},e}();function K(e,t,r,n,i){return[r].concat(t.map((function(t){return v(t,e[t],i)}))).join(n)}function v(e,t,r){var n=String(t);return"number"==typeof t&&t>=0&&r&&(n=function(e){var t=String(e).split("."),r=t[1];return[(t[0]||"").padStart(18,"0"),(r||"").padEnd(2,"0")].join(".")}(t)),e+"-"+n}function g(e,t,r,n){var i;return(i={})[t.hashKeyAttribute]=K(e,t.hashKeyFields,t.hashKeyDescriptor,r,n),i[t.sortKeyAttribute]=K(e,t.sortKeyFields,t.sortKeyDescriptor,r,n),i}exports.AWS=t,exports.WORKAROUND_updateAWSConfig=function(e,n){t.config.update(e),u=new t.DynamoDB.DocumentClient(r({},e,{},n))},exports.ensureTableAndIndexesExist=function(e){try{var s=function(e){var t={};return e.map((function(e){return e.config})).forEach((function(e){t[e.tableName]||(t[e.tableName]={}),e.indexes.forEach((function(r){"globalSecondaryIndex"===r.type&&(t[e.tableName][r.indexName]=r)}))})),t}(e),u=Object.keys(s),a=function(e,t,r){var s,u,a=-1;return function r(c){try{for(;++a<e.length;)if((c=t(a))&&c.then){if(!o(c))return void c.then(r,u||(u=i.bind(null,s=new n,2)));c=c.v}s?i(s,1,c):s=c}catch(e){i(s||(s=new n),2,e)}}(),s}(u,(function(e){return Promise.resolve(function(e,n){try{var i=new t.DynamoDB;return console.log('checking if the table "'+e+'" has already been created'),Promise.resolve(function(e,t){try{var r=function(e){return n?e:(console.log("returning nullll"),null)},n=!1,i=function(r,i){try{var o=(console.log("calling for describeTable"),Promise.resolve(e.describeTable({TableName:t}).promise()).then((function(e){if(e.Table)return console.log("returning table description"),n=!0,e.Table})))}catch(e){return i(e)}return o&&o.then?o.then(void 0,i):o}(0,(function(e){console.log(e)}));return Promise.resolve(i&&i.then?i.then(r):r(i))}catch(e){return Promise.reject(e)}}(i,e)).then((function(o){var s=!1;function u(t){if(s)return t;console.log('table "'+e+'" already exists, checking the indexes'),o&&(o.GlobalSecondaryIndexes||[]).forEach((function(e){delete a[e.IndexName||""]}));var r=Object.values(a),n=function(){if(r.length>0)return console.log("creating the following indexes "+Object.keys(a).join(",")+" to table "+e),Promise.resolve(i.updateTable({TableName:e,AttributeDefinitions:r.reduce((function(e,t){return e.concat([{AttributeName:t.sortKeyAttribute,AttributeType:"S"},{AttributeName:t.hashKeyAttribute,AttributeType:"S"}])}),[]),GlobalSecondaryIndexUpdates:r.map((function(e){return{Create:m(e)}}))}).promise()).then((function(){return Promise.resolve(i.waitFor("tableExists",{TableName:e})).then((function(){}))}));console.log("the table "+e+" has all the necessary indexes")}();return n&&n.then?n.then((function(){})):void 0}console.log("got the description",o);var a=r({},n),c=function(){if(!o){var r=Object.values(a);return console.log('table "'+e+'" does not exist, creating it now'),Promise.resolve(function(e){var r=function(e){var t=function(e,t){for(var r=[],n=0;n<=4;n++)r.push(n);return r}().map((function(e){return{indexName:h(e),sortKeyAttributeName:l(e)}})),r=(e.indexes||[]).map((function(e){return m(e)})),n={TableName:e.tableName||d(),KeySchema:[{AttributeName:"__hashKey",KeyType:"HASH"},{AttributeName:"__sortKey",KeyType:"RANGE"}],AttributeDefinitions:[{AttributeName:"__hashKey",AttributeType:"S"},{AttributeName:"__sortKey",AttributeType:"S"}].concat(t.map((function(e){return{AttributeName:e.sortKeyAttributeName,AttributeType:"S"}})),e.indexes.map((function(e){return{AttributeName:e.sortKeyAttribute,AttributeType:"S"}})),e.indexes.map((function(e){return{AttributeName:e.hashKeyAttribute,AttributeType:"S"}}))),LocalSecondaryIndexes:[].concat(t.map((function(e){return{IndexName:e.indexName,KeySchema:[{AttributeName:"__hashKey",KeyType:"HASH"},{AttributeName:e.sortKeyAttributeName,KeyType:"RANGE"}],Projection:{ProjectionType:"ALL"}}}))),GlobalSecondaryIndexes:r,BillingMode:"PAY_PER_REQUEST"};return 0===n.LocalSecondaryIndexes.length&&delete n.LocalSecondaryIndexes,0===n.GlobalSecondaryIndexes.length&&delete n.GlobalSecondaryIndexes,n}(e),n=new t.DynamoDB;return n.createTable(r).promise().then((function(){return n.waitFor("tableExists",{TableName:r.TableName})})).then((function(){return console.log(r.TableName+" has been created")}))}({tableName:e,indexes:r})).then((function(){console.log('table "'+e+'" created with the following indexes '+Object.keys(a).join(",")),s=!0}))}}();return c&&c.then?c.then(u):u(c)}))}catch(e){return Promise.reject(e)}}(u[e],s[u[e]])).then((function(){}))}));return Promise.resolve(a&&a.then?a.then((function(){})):void 0)}catch(e){return Promise.reject(e)}},exports.getRepository=function(e){var t=function(e){var t=Object.assign({shouldPadNumbersInIndexes:!0,paddedNumberLength:20,queries:{}},e),n=[b(t)].concat(t.indexes?Object.keys(t.indexes).map((function(e){return function(e,t){var r,n=(t.indexes||{})[e];if((r=n)&&r.isPrimary)return b(t,e);if(function(e){return e&&e.sortKeyFields&&!e.hashKeyFields}(n))return function(e,t,r){return{isCustomIndex:!1,hashKeyFields:r.hashKeyFields,hashKeyDescriptor:r.objectName,hashKeyAttribute:"__hashKey",sortKeyFields:t.sortKeyFields,sortKeyDescriptor:e,sortKeyAttribute:l(t.which),indexName:h(t.which),type:"localSecondaryIndex",tag:e}}(e,n,t);if(function(e){return e&&e.sortKeyFields&&e.hashKeyFields}(n))return function(e,t,r){return{isCustomIndex:!1,hashKeyFields:t.hashKeyFields,hashKeyDescriptor:r.objectName+"-"+e,hashKeyAttribute:y(t.which,"Hash"),sortKeyFields:t.sortKeyFields,sortKeyDescriptor:e,sortKeyAttribute:y(t.which,"Sort"),indexName:(n=t.which,"__gsi"+n),type:"globalSecondaryIndex",tag:e};var n}(e,n,t);if(function(e){return e&&e.hashKeyAttributeName&&e.sortKeyAttributeName}(n))return function(e,t,r){return{isCustomIndex:!0,hashKeyFields:[],hashKeyDescriptor:r.objectName+"-"+e,hashKeyAttribute:t.hashKeyAttributeName,sortKeyFields:[],sortKeyDescriptor:e,sortKeyAttribute:t.sortKeyAttributeName,indexName:t.indexName||e,type:"globalSecondaryIndex",tag:e}}(e,n,t);throw{message:e+" is not valid"}}(e,t)})):[]),i=n.reduce((function(e,t){var n;return r({},e,((n={})[t.tag]=t,n))}),{});return Object.assign({tableName:t.tableName||d(),compositeKeySeparator:t.compositeKeySeparator||"#",shouldPadNumbersInIndexes:t.shouldPadNumbersInIndexes,paddedNumberLength:t.paddedNumberLength||20},{objectName:t.objectName,primaryIndex:n[0],indexes:n,indexesByTag:i})}(e),n={getDocClient:a,get config(){return t},getCursor:function(e,i){var o,s,u,a=n.formatForDDB(e);return r(((o={})[t.primaryIndex.hashKeyAttribute]=a[t.primaryIndex.hashKeyAttribute],o[t.primaryIndex.sortKeyAttribute]=a[t.primaryIndex.sortKeyAttribute],o),i&&((s={})[i.hashKeyAttribute]=a[i.hashKeyAttribute],s),{},i&&((u={})[i.sortKeyAttribute]=a[i.sortKeyAttribute],u))},getKey:function(e){return g(e,t.primaryIndex,t.compositeKeySeparator,t.shouldPadNumbersInIndexes)},get:function(e){try{return Promise.resolve(n.batchGet([e])).then((function(e){return e[0]}))}catch(e){return Promise.reject(e)}},batchGet:function(e){try{var r;return 0===e.length?Promise.resolve([]):Promise.resolve(a().batchGet({RequestItems:(r={},r[t.tableName]={Keys:e.map(n.getKey)},r)}).promise()).then((function(e){return e.Responses&&e.Responses[t.tableName]?e.Responses[t.tableName].map((function(e){return e?c(e):null})):[]}))}catch(e){return Promise.reject(e)}},update:function(e,t){try{return Promise.resolve(n.get(e)).then((function(e){var i=r({},e,{},t);return n.overwrite(i)}))}catch(e){return Promise.reject(e)}},put:function(e){return n.overwrite(e)},overwrite:function(e){try{return Promise.resolve(a().put({TableName:t.tableName,Item:n.formatForDDB(e)}).promise()).then((function(){return e}))}catch(e){return Promise.reject(e)}},delete:function(e){try{return Promise.resolve(n.batchDelete([e])).then((function(){return!0}))}catch(e){return Promise.reject(e)}},batchDelete:function(e){try{var r;return 0===e.length?Promise.resolve([]):Promise.resolve(a().batchWrite({RequestItems:(r={},r[t.tableName]=e.map((function(e){return{DeleteRequest:{Key:n.getKey(e)}}})),r)}).promise()).then((function(){return e.map((function(){return!0}))}))}catch(e){return Promise.reject(e)}},getSortKeyAndHashKeyForQuery:function(e,r){if(r.isCustomIndex)return{hashKey:e.args[r.hashKeyAttribute],sortKey:e.args[r.sortKeyAttribute]};var n=K(e.args,r.hashKeyFields,r.hashKeyDescriptor,t.compositeKeySeparator,t.shouldPadNumbersInIndexes);return{sortKey:r.sortKeyFields&&function(e,t,r,n,i){for(var o=[r],s=0;s<t.length;s++){var u=t[s];if(!(u in e))break;o.push(v(u,String(e[u]),i))}return o.join(n)}(e.args,r.sortKeyFields,r.sortKeyDescriptor,t.compositeKeySeparator,t.shouldPadNumbersInIndexes),hashKey:n}},getQueryArgs:function(e,n){var i=this.getSortKeyAndHashKeyForQuery(e,n),o=i.sortKey,s=i.hashKey;return r({TableName:t.tableName},n.indexName&&{IndexName:n.indexName},{Limit:e.limit||5,ScanIndexForward:"asc"===e.sort,KeyConditionExpression:"#hKeyAttribute = :hKey "+(o?"and begins_with(#sKeyAttribute, :sKey)":""),ExpressionAttributeNames:r({"#hKeyAttribute":n.hashKeyAttribute},o&&{"#sKeyAttribute":n.sortKeyAttribute}),ExpressionAttributeValues:r({":hKey":s},o&&{":sKey":o})},e.cursor&&{ExclusiveStartKey:e.cursor})},executeQuery:function(e,t){try{return Promise.resolve(a().query(n.getQueryArgs(e,t)).promise()).then((function(t){var n=t&&t.LastEvaluatedKey&&r({},e,{cursor:t.LastEvaluatedKey});return{results:t.Items.map((function(e){return c(e)})),nextPageArgs:n}}))}catch(e){return Promise.reject(e)}},query:function(e){var t=new p(n);return e?t.setClause(e):t},formatForDDB:function(e){var n=r({},e,{__objectType:t.objectName});return t.indexes.filter((function(e){return!e.isCustomIndex})).forEach((function(i){n=r({},n,{},g(e,i,t.compositeKeySeparator,t.shouldPadNumbersInIndexes))})),n},findIndexForQuery:function(e){return function(e,t){if(e.index){if(t.indexesByTag[e.index])return t.indexesByTag[e.index];throw{message:'The index "'+e.index+'" does not exist, the following are valid indexes: '+Object.keys(t.indexesByTag).join(",")}}for(var r=t.indexes,n=function(t){var n=r[t],i=new Set(Object.keys(e.args));if(n.hashKeyFields.every((function(e){return i.has(e)}))){n.hashKeyFields.forEach((function(e){return i.delete(e)}));var o=i.size;if(n.sortKeyFields.slice(0,i.size).forEach((function(e){return i.delete(e)})),0===i.size){if(!e.sortBy)return{v:n};if(n.sortKeyFields.indexOf(e.sortBy)===o)return{v:n}}}},i=0;i<r.length;i++){var o=n(i);if("object"==typeof o)return o.v}return null}(e,t)},indexes:Object.keys(t.indexesByTag).reduce((function(e,t){return e[t]=function(){return n.query().index(t)},e}),{})};return n},exports.setDefaultTableName=function(e){f=e};
//# sourceMappingURL=single-table-dynamo.cjs.production.min.js.map
